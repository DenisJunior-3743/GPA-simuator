name: Build Android APK (optional)

on:
  push:
    branches: [ main, master, Denis, build ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build:
    name: Build Android APK (if buildozer.spec present)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check for buildozer.spec
        run: |
          if [ ! -f "buildozer.spec" ]; then
            echo "No buildozer.spec found - skipping Android build"
            exit 78
          fi
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git python3-dev ffmpeg libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev zlib1g-dev || true
          python3 -m pip install --upgrade pip
          pip install buildozer cython kivy
      - name: Accept Android SDK licenses
        run: |
          # Prefer using the runner-installed SDK, but also prepare the Buildozer-downloaded SDK path.
          export ANDROID_SDK_ROOT=$ANDROID_HOME
          BUILDOZER_SDK="$HOME/.buildozer/android/platform/android-sdk"
          mkdir -p $ANDROID_SDK_ROOT/licenses
          mkdir -p $BUILDOZER_SDK/licenses

          # Write license acceptance files (checksums only) into both SDK locations
          for L in "$ANDROID_SDK_ROOT/licenses" "$BUILDOZER_SDK/licenses"; do
            echo "8933bad161af4b6a5b573652ffc7aaf3aee85a47" > $L/android-sdk-license
            echo "d56f5187479451eabf01fb78af6dfcb131b33910" > $L/android-sdk-preview-license
            echo "84831b9409646a918e30573bab4c9c91346d8abd" > $L/google-tv-preview-license
          done

          # Try to find sdkmanager in multiple possible locations (Buildozer SDK first)
          SDKMANAGER_PATH=""
          if [ -x "$BUILDOZER_SDK/cmdline-tools/latest/bin/sdkmanager" ]; then
            SDKMANAGER_PATH="$BUILDOZER_SDK/cmdline-tools/latest/bin/sdkmanager"
          elif [ -x "$BUILDOZER_SDK/tools/bin/sdkmanager" ]; then
            SDKMANAGER_PATH="$BUILDOZER_SDK/tools/bin/sdkmanager"
          elif [ -x "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" ]; then
            SDKMANAGER_PATH="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"
          elif [ -x "$ANDROID_HOME/tools/bin/sdkmanager" ]; then
            SDKMANAGER_PATH="$ANDROID_HOME/tools/bin/sdkmanager"
          fi

          if [ -n "$SDKMANAGER_PATH" ]; then
            echo "Found sdkmanager at: $SDKMANAGER_PATH"
            yes | $SDKMANAGER_PATH --licenses || true
          else
            echo "Warning: sdkmanager not found yet. Pre-created license files in both SDK locations. Proceeding to buildozer which will use the Buildozer SDK path."
          fi
      - name: Build APK
        run: |
          # Ensure Buildozer uses the SDK we prepared (Buildozer downloads SDK under $HOME/.buildozer/...)
          export ANDROID_SDK_ROOT="$HOME/.buildozer/android/platform/android-sdk"
          export ANDROID_HOME="$ANDROID_SDK_ROOT"
          echo "ANDROID_SDK_ROOT is set to: $ANDROID_SDK_ROOT"
          buildozer android debug
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: gpa-simulator-android
          path: bin/*.apk
          if-no-files-found: ignore
  create-release:
    name: Create Release with Android builds
    needs: build
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: release-${{ github.run_id }}-android
          name: Android Build (Run ${{ github.run_number }})
          files: release-artifacts/**/*
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}