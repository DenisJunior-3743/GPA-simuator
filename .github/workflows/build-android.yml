name: Build Android APK (optional)

on:
  push:
    branches: [ main, master, Denis, build ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build:
    name: Build Android APK (if buildozer.spec present)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check for buildozer.spec
        run: |
          if [ ! -f "buildozer.spec" ]; then
            echo "No buildozer.spec found - skipping Android build"
            exit 78
          fi
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git python3-dev ffmpeg libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev zlib1g-dev || true
          python3 -m pip install --upgrade pip
          pip install buildozer cython kivy
      - name: Accept Android SDK licenses
        run: |
          export ANDROID_SDK_ROOT=$ANDROID_HOME
          mkdir -p $ANDROID_SDK_ROOT/licenses
          
          # Write license acceptance files (checksums only, no newlines at start)
          echo "8933bad161af4b6a5b573652ffc7aaf3aee85a47" > $ANDROID_SDK_ROOT/licenses/android-sdk-license
          echo "d56f5187479451eabf01fb78af6dfcb131b33910" > $ANDROID_SDK_ROOT/licenses/android-sdk-preview-license
          echo "84831b9409646a918e30573bab4c9c91346d8abd" > $ANDROID_SDK_ROOT/licenses/google-tv-preview-license
          
          # Find and use sdkmanager to accept licenses
          SDKMANAGER_PATH=""
          if [ -x "$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager" ]; then
            SDKMANAGER_PATH="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"
          elif [ -x "$ANDROID_HOME/tools/bin/sdkmanager" ]; then
            SDKMANAGER_PATH="$ANDROID_HOME/tools/bin/sdkmanager"
          fi
          
          if [ -n "$SDKMANAGER_PATH" ]; then
            echo "Found sdkmanager at: $SDKMANAGER_PATH"
            yes | $SDKMANAGER_PATH --licenses || true
          else
            echo "Warning: sdkmanager not found, using pre-created license files"
          fi
      - name: Build APK
        run: |
          export ANDROID_SDK_ROOT=$ANDROID_HOME
          buildozer android debug
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: gpa-simulator-android
          path: bin/*.apk
          if-no-files-found: ignore
  create-release:
    name: Create Release with Android builds
    needs: build
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: release-${{ github.run_id }}-android
          name: Android Build (Run ${{ github.run_number }})
          files: release-artifacts/**/*
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}