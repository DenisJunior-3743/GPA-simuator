name: Build macOS App

on:
  push:
    branches: [ main, master, Denis, build ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build:
    name: Build macOS
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install Python deps
        run: |
          python3 -m pip install --upgrade pip --break-system-packages
          pip install -r requirements.txt --break-system-packages
          pip install pyinstaller --break-system-packages
      - name: Build with PyInstaller
        run: |
          if [ -f "gpa_simulator.spec" ]; then
            pyinstaller gpa_simulator.spec
          else
            pyinstaller --distpath "./dist-macos" --windowed ui_app.py
          fi
      - name: Package DMG
        continue-on-error: true
        run: |
          mkdir -p "dist/GPA Simulator.app/Contents/MacOS"
          mkdir -p "dist/GPA Simulator.app/Contents/Resources"
          if [ -f "dist/gpa_simulator" ]; then
            cp "dist/gpa_simulator" "dist/GPA Simulator.app/Contents/MacOS/"
          elif [ -d "dist/gpa_simulator" ]; then
            cp -r "dist/gpa_simulator"/* "dist/GPA Simulator.app/Contents/MacOS/"
          fi
          if [ -f "gpa.ico" ]; then cp "gpa.ico" "dist/GPA Simulator.app/Contents/Resources/"; fi
          brew install create-dmg || true
          if [ -d "dist/GPA Simulator.app" ]; then
            create-dmg \
              --volname "GPA Simulator" \
              --window-pos 200 120 \
              --window-size 800 600 \
              --icon-size 120 \
              --icon "GPA Simulator.app" 200 190 \
              gpa-simulator.dmg \
              "dist/GPA Simulator.app"
          fi
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: gpa-simulator-macos
          path: gpa-simulator.dmg
          if-no-files-found: ignore
  create-release:
    name: Create Release with macOS builds
    needs: build
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: release-${{ github.run_id }}-macos
          name: macOS Build (Run ${{ github.run_number }})
          files: release-artifacts/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}